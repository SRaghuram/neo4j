#
# Copyright (c) 2002-2020 "Neo4j,"
# Neo4j Sweden AB [http://neo4j.com]
# This file is part of Neo4j internal tooling.
#

---
  - hosts: machines
    remote_user: neo
    become: yes
    environment:
      JAVA_HOME: /usr/lib/jvm/oracle-jdk-8
    tasks:
      - name: add apt repo
        apt_repository:
          repo: ppa:linuxuprising/java
          state: present
          update_cache: yes
      - name: accept oracle license
        debconf:
          name: oracle-java11-installer
          question: 'shared/accepted-oracle-license-v1-2'
          value: 'true'
          vtype: 'select'
      - name: install jdk and tools
        apt:
          name:
            - oracle-java11-installer
            - systemd-coredump
          state: present
          update_cache: yes
      - name: Create symbolic link for Java 11
        file:
          src: "/usr/lib/jvm/java-11-oracle"
          dest: "/usr/lib/jvm/oracle-jdk-11"
          state: link
      - name: update core limit size limits
        pam_limits:
          domain: teamcity
          limit_item: core
          limit_type: '-'
          value: unlimited
        notify: reload sysctl
      - name: install teamcity agent as a service
        template:
          src: templates/etc/systemd/system/teamcity-agent.service
          dest: /etc/systemd/system/teamcity-agent.service
        notify: enabled teamcity agent service
    handlers:
      - name: enabled teamcity agent service
        systemd:
          name: teamcity-agent.service
          daemon_reload: true
          enabled: true
          state: restarted
      - name: reload sysctl
        shell: sysctl --system
