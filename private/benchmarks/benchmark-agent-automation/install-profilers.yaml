#
# Copyright (c) 2002-2020 "Neo4j,"
# Neo4j Sweden AB [http://neo4j.com]
# This file is part of Neo4j internal tooling.
#

---
  - hosts: machines
    remote_user: neo
    environment:
      JAVA_HOME: /usr/lib/jvm/oracle-jdk-8
    tasks:
      - name: clone FlameGraph
        command: git clone https://github.com/brendangregg/FlameGraph.git
        args:
          creates: /tmp/FlameGraph
          chdir: /tmp
      - name: set proper version of FlameGraph
        command: git reset --hard 18c3dea3b2c55ae66768936f1039e36a12b627f6
        args:
          chdir: /tmp/FlameGraph
      - name: create FlameGraph directory
        file:
          path: /opt/profiling/FlameGraph
          state: directory
      - name: copy FlameGraphs to final destination
        shell: cp -R --remove-destination /tmp/FlameGraph/* /opt/profiling/FlameGraph
        become: yes
      - name: clone jfr-flame-graph
        command: git clone https://github.com/chrishantha/jfr-flame-graph.git
        args:
          creates: /tmp/jfr-flame-graph
          chdir: /tmp
      - name: set proper version of jfr-flame-graph
        command: git reset --hard e14e3d43f23f2ea8ac38b26e46980ba0b784e5d1
        args:
          chdir: /tmp/jfr-flame-graph
      - name: build jfr-flame-graph
        command: ./gradlew installDist
        args:
          chdir: /tmp/jfr-flame-graph
      - name: remove old backup of jfr-flame-graph
        file:
          path: /opt/profiling/jfr-flame-graph.old/jfr-flame-graph
          state: absent
        become: yes
      - name: backup jfr-flame-graph
        command: mv -v /opt/profiling/jfr-flame-graph /opt/profiling/jfr-flame-graph.old
        become: yes
      - name: create jfr-flame-graph directory
        file:
          path: /opt/profiling/jfr-flame-graph
          state: directory
        become: yes
      - name: copy jfr-flame-graph to final destination
        shell: cp -R --remove-destination /tmp/jfr-flame-graph/build/install/jfr-flame-graph/* /opt/profiling/jfr-flame-graph
        become: yes
      - name: check async-profiler directory exists
        stat:
          path: /opt/profiling/async-profiler
        register: asyncdir
        become: yes
        tags:
          - async_profiler
      - name: remove async-profiler directory if exists
        file:
          path: /opt/profiling/async-profiler
          state: absent
        when: asyncdir.stat.exists
        become: yes
        tags:
          - async_profiler
      - name: create directory for async profiler
        file:
          path: /opt/profiling/async-profiler
          state: directory
        become: yes
        tags:
          - async_profiler
      - name: install async profiler
        unarchive:
          src: https://github.com/jvm-profiling-tools/async-profiler/releases/download/v1.8/async-profiler-1.8-linux-x64.tar.gz
          dest: "/opt/profiling/async-profiler"
          extra_opts: [--strip-components=1]
          remote_src: yes
        become: yes
        tags:
          - async_profiler
