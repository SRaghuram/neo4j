{
  "Parameters": {
    "AMIID": {
      "Description": "AMI Id",
      "Type": "String"
    },
    "NEO4JCOMMIT": {
      "Description": "commit cloud formation was build from",
      "Type": "String"
    },
    "STAGE": {
      "Description": "current production stage",
      "Type": "String",
      "Default": "test"
    },
    "BUILDID": {
      "Description": "build id",
      "Type": "String"
    },
    "ORACLE11WORKERIMAGE": {
      "Description": "result store secret",
      "Type": "String",
      "Default": "535893049302.dkr.ecr.eu-north-1.amazonaws.com/benchmarks-worker:oracle_11"
    },
    "ORACLE8WORKERIMAGE": {
      "Description": "result store secret",
      "Type": "String",
      "Default": "535893049302.dkr.ecr.eu-north-1.amazonaws.com/benchmarks-worker:oracle_8"
    }
  },
  "Resources": {
    "BenchmarkingWorkerSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Allow ssh into benchmarking worker instances",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "SecurityGroupEgress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "1",
            "ToPort": "65535",
            "CidrIp": "0.0.0.0/0"
          }
        ],
      "VpcId" : "vpc-39d63b50"
      }
    },
    "M5D2XLargeComputeEnvironment": {
      "Type": "AWS::Batch::ComputeEnvironment",
      "Properties": {
        "Type": "MANAGED",
        "ComputeResources": {
          "Type": "EC2",
          "ImageId": {
            "Ref": "AMIID"
          },
          "Ec2KeyPair": "benchmark",
          "MinvCpus": 0,
          "DesiredvCpus": 0,
          "MaxvCpus": 512,
          "InstanceTypes": [
            "m5d.2xlarge"
          ],
          "Subnets": [
            "subnet-ff6f40b5",
            "subnet-3a8c6e53",
            "subnet-553c312d"
          ],
          "SecurityGroupIds": [
            "sg-bcab66d5",
            {
              "Fn::GetAtt": [
                "BenchmarkingWorkerSecurityGroup",
                "GroupId"
              ]
            }
          ],
          "InstanceRole": "arn:aws:iam::535893049302:instance-profile/ecsInstanceRole",
          "Tags": {
            "team": "benchmarking",
            "project": "infrastructure",
            "neo4jcommit": {
              "Ref": "NEO4JCOMMIT"
            },
            "owner": "benchmarking",
            "stage": {
              "Ref": "STAGE"
            }
          }
        },
        "ServiceRole": "arn:aws:iam::535893049302:role/service-role/AWSBatchServiceRole"
      }
    },
    "M5DXLargeComputeEnvironment": {
      "Type": "AWS::Batch::ComputeEnvironment",
      "Properties": {
        "Type": "MANAGED",
        "ComputeResources": {
          "Type": "EC2",
          "ImageId": {
            "Ref": "AMIID"
          },
          "Ec2KeyPair": "benchmark",
          "MinvCpus": 0,
          "DesiredvCpus": 0,
          "MaxvCpus": 512,
          "InstanceTypes": [
            "m5d.large"
          ],
          "Subnets": [
            "subnet-ff6f40b5",
            "subnet-3a8c6e53",
            "subnet-553c312d"
          ],
          "SecurityGroupIds": [
            "sg-bcab66d5",
            {
              "Fn::GetAtt": [
                "BenchmarkingWorkerSecurityGroup",
                "GroupId"
              ]
            }
          ],
          "InstanceRole": "arn:aws:iam::535893049302:instance-profile/ecsInstanceRole",
          "Tags": {
            "team": "benchmarking",
            "project": "infrastructure",
            "neo4jcommit": {
              "Ref": "NEO4JCOMMIT"
            },
            "owner": "benchmarking",
            "stage": {
              "Ref": "STAGE"
            }
          }
        },
        "ServiceRole": "arn:aws:iam::535893049302:role/service-role/AWSBatchServiceRole"
      }
    },
    "R5D2XLargeComputeEnvironment": {
      "Type": "AWS::Batch::ComputeEnvironment",
      "Properties": {
        "Type": "MANAGED",
        "ComputeResources": {
          "Type": "EC2",
          "ImageId": {
            "Ref": "AMIID"
          },
          "Ec2KeyPair": "benchmark",
          "MinvCpus": 0,
          "DesiredvCpus": 0,
          "MaxvCpus": 512,
          "InstanceTypes": [
            "r5d.2xlarge"
          ],
          "Subnets": [
            "subnet-ff6f40b5",
            "subnet-3a8c6e53",
            "subnet-553c312d"
          ],
          "SecurityGroupIds": [
            "sg-bcab66d5",
            {
              "Fn::GetAtt": [
                "BenchmarkingWorkerSecurityGroup",
                "GroupId"
              ]
            }
          ],
          "InstanceRole": "arn:aws:iam::535893049302:instance-profile/ecsInstanceRole",
          "Tags": {
            "team": "benchmarking",
            "project": "infrastructure",
            "neo4jcommit": {
              "Ref": "NEO4JCOMMIT"
            },
            "owner": "benchmarking",
            "stage": {
              "Ref": "STAGE"
            }
          }
        },
        "ServiceRole": "arn:aws:iam::535893049302:role/service-role/AWSBatchServiceRole"
      }
    },
    "MacroBenchmarkRunQueueXLarge": {
      "Type": "AWS::Batch::JobQueue",
      "Properties": {
        "ComputeEnvironmentOrder": [
          {
            "Order": 1,
            "ComputeEnvironment": {
              "Ref": "M5D2XLargeComputeEnvironment"
            }
          }
        ],
        "JobQueueName": {
          "Fn::Sub": "M5D2XLargeJobQueue-${BUILDID}"
        },
        "Priority": 1
      }
    },
    "MacroBenchmarkRunQueueLarge": {
      "Type": "AWS::Batch::JobQueue",
      "Properties": {
        "ComputeEnvironmentOrder": [
          {
            "Order": 1,
            "ComputeEnvironment": {
              "Ref": "M5DXLargeComputeEnvironment"
            }
          }
        ],
        "JobQueueName": {
          "Fn::Sub": "M5DLargeJobQueue-${BUILDID}"
        },
        "Priority": 1
      }
    },
    "MicroBenchmarkRunQueueLarge": {
      "Type": "AWS::Batch::JobQueue",
      "Properties": {
        "ComputeEnvironmentOrder": [
          {
            "Order": 1,
            "ComputeEnvironment": {
              "Ref": "R5D2XLargeComputeEnvironment"
            }
          }
        ],
        "JobQueueName": {
          "Fn::Sub": "R5D2XLargeJobQueue-${BUILDID}"
        },
        "Priority": 1
      }
    },
    "MacroBenchmarkRunJobDefintionLargeJDK11": {
      "Type": "AWS::Batch::JobDefinition",
      "Properties": {
        "JobDefinitionName": {
          "Fn::Sub": "macro-benchmark-job-definition-oracle11-${STAGE}"
        },
        "Type": "container",
        "ContainerProperties": {
          "Image": {
            "Ref": "ORACLE11WORKERIMAGE"
          },
          "Command": [
            "/work/bootstrap-worker.sh",
            "--worker-artifact-uri",
            "Ref::--worker-artifact-uri",
            "run-worker",
            "--artifact-base-uri",
            "Ref::--artifact-base-uri"
          ],
          "Volumes": [
            {
              "Host": {
                "SourcePath": "/work"
              },
              "Name": "work"
            }
          ],
          "MountPoints": [
            {
              "SourceVolume": "work",
              "ContainerPath": "/work/run",
              "ReadOnly": false
            }
          ],
          "Privileged": true,
          "Vcpus": 8,
          "Memory": 31000,
          "Ulimits": [
            {
              "Name": "nofile",
              "SoftLimit": 80000,
              "HardLimit": 80000
            }
          ]
        }
      }
    },
    "MacroBenchmarkRunJobDefintionSmallJDK11": {
      "Type": "AWS::Batch::JobDefinition",
      "Properties": {
        "JobDefinitionName": {
          "Fn::Sub": "macro-benchmark-job-definition-small-oracle11-${STAGE}"
        },
        "Type": "container",
        "ContainerProperties": {
          "Image": {
            "Ref": "ORACLE11WORKERIMAGE"
          },
          "Command": [
            "/work/bootstrap-worker.sh",
            "--worker-artifact-uri",
            "Ref::--worker-artifact-uri",
            "run-worker",
            "--artifact-base-uri",
            "Ref::--artifact-base-uri"
          ],
          "Volumes": [
            {
              "Host": {
                "SourcePath": "/work"
              },
              "Name": "work"
            }
          ],
          "MountPoints": [
            {
              "SourceVolume": "work",
              "ContainerPath": "/work/run",
              "ReadOnly": false
            }
          ],
          "Privileged": true,
          "Vcpus": 2,
          "Memory": 7000,
          "Ulimits": [
            {
              "Name": "nofile",
              "SoftLimit": 80000,
              "HardLimit": 80000
            }
          ]
        }
      }
    },
    "MacroBenchmarkRunJobDefintionLargeJDK8": {
      "Type": "AWS::Batch::JobDefinition",
      "Properties": {
        "JobDefinitionName": {
          "Fn::Sub": "macro-benchmark-job-definition-oracle8-${STAGE}"
        },
        "Type": "container",
        "ContainerProperties": {
          "Image": {
            "Ref": "ORACLE8WORKERIMAGE"
          },
          "Command": [
            "/work/bootstrap-worker.sh",
            "--worker-artifact-uri",
            "Ref::--worker-artifact-uri",
            "run-worker",
            "--artifact-base-uri",
            "Ref::--artifact-base-uri"
          ],
          "Volumes": [
            {
              "Host": {
                "SourcePath": "/work"
              },
              "Name": "work"
            }
          ],
          "MountPoints": [
            {
              "SourceVolume": "work",
              "ContainerPath": "/work/run",
              "ReadOnly": false
            }
          ],
          "Privileged": true,
          "Vcpus": 8,
          "Memory": 31000,
          "Ulimits": [
            {
              "Name": "nofile",
              "SoftLimit": 80000,
              "HardLimit": 80000
            }
          ]
        }
      }
    },
    "MacroBenchmarkRunJobDefintionSmallJDK8": {
      "Type": "AWS::Batch::JobDefinition",
      "Properties": {
        "JobDefinitionName": {
          "Fn::Sub": "macro-benchmark-job-definition-small-oracle8-${STAGE}"
        },
        "Type": "container",
        "ContainerProperties": {
          "Image": {
            "Ref": "ORACLE8WORKERIMAGE"
          },
          "Command": [
            "/work/bootstrap-worker.sh",
            "--worker-artifact-uri",
            "Ref::--worker-artifact-uri",
            "run-worker",
            "--artifact-base-uri",
            "Ref::--artifact-base-uri"
          ],
          "Volumes": [
            {
              "Host": {
                "SourcePath": "/work"
              },
              "Name": "work"
            }
          ],
          "MountPoints": [
            {
              "SourceVolume": "work",
              "ContainerPath": "/work/run",
              "ReadOnly": false
            }
          ],
          "Privileged": true,
          "Vcpus": 2,
          "Memory": 7000,
          "Ulimits": [
            {
              "Name": "nofile",
              "SoftLimit": 80000,
              "HardLimit": 80000
            }
          ]
        }
      }
    },
    "MicroBenchmarkRunJobDefintionLargeJDK8": {
      "Type": "AWS::Batch::JobDefinition",
      "Properties": {
        "JobDefinitionName": {
          "Fn::Sub": "micro-benchmark-job-definition-oracle8-${STAGE}"
        },
        "Type": "container",
        "ContainerProperties": {
          "Image": {
            "Ref": "ORACLE8WORKERIMAGE"
          },
          "Command": [
            "/work/bootstrap-worker.sh",
            "--worker-artifact-uri",
            "Ref::--worker-artifact-uri",
            "run-worker",
            "--artifact-base-uri",
            "Ref::--artifact-base-uri"
          ],
          "Volumes": [
            {
              "Host": {
                "SourcePath": "/work"
              },
              "Name": "work"
            }
          ],
          "MountPoints": [
            {
              "SourceVolume": "work",
              "ContainerPath": "/work/run",
              "ReadOnly": false
            }
          ],
          "Privileged": true,
          "Vcpus": 8,
          "Memory": 63000,
          "Ulimits": [
            {
              "Name": "nofile",
              "SoftLimit": 280000,
              "HardLimit": 280000
            }
          ]
        }
      }
    },
    "MicroBenchmarkRunJobDefintionLargeJDK11": {
      "Type": "AWS::Batch::JobDefinition",
      "Properties": {
        "JobDefinitionName": {
          "Fn::Sub": "micro-benchmark-job-definition-oracle11-${STAGE}"
        },
        "Type": "container",
        "ContainerProperties": {
          "Image": {
            "Ref": "ORACLE11WORKERIMAGE"
          },
          "Command": [
            "/work/bootstrap-worker.sh",
            "--worker-artifact-uri",
            "Ref::--worker-artifact-uri",
            "run-worker",
            "--artifact-base-uri",
            "Ref::--artifact-base-uri"
          ],
          "Volumes": [
            {
              "Host": {
                "SourcePath": "/work"
              },
              "Name": "work"
            }
          ],
          "MountPoints": [
            {
              "SourceVolume": "work",
              "ContainerPath": "/work/run",
              "ReadOnly": false
            }
          ],
          "Privileged": true,
          "Vcpus": 8,
          "Memory": 63000,
          "Ulimits": [
            {
              "Name": "nofile",
              "SoftLimit": 280000,
              "HardLimit": 280000
            }
          ]
        }
      }
    }
  },
  "Outputs": {
    "M5D2XLargeJobQueue": {
      "Value": {
        "Fn::Sub": "M5D2XLargeJobQueue-${BUILDID}"
      }
    },
    "M5DLargeJobQueue": {
      "Value": {
        "Fn::Sub": "M5DLargeJobQueue-${BUILDID}"
      }
    },
    "R5D2XLargeJobQueue": {
      "Value": {
        "Fn::Sub": "R5D2XLargeJobQueue-${BUILDID}"
      }
    }
  }
}
